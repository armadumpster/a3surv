{
	private _fnc_scriptNameParent = if (isNil '_fnc_scriptName') then {'A3SClient_fnc_Construction_thread'} else {_fnc_scriptName};
	private _fnc_scriptName = 'A3SClient_fnc_Construction_thread';
	scriptName _fnc_scriptName;

#line 1 "A3S_client\bin\scripts\basebuilding\fn_Construction_thread.sqf [A3SClient_fnc_Construction_thread]"

scriptName"fn_Construction_thread";private["_boundingBox","_boundingBoxMinimum","_boundingBoxMaximum","_boundingBoxPointsTop","_boundingBoxPointsBottom","_objectColor","_materialColor","_position","_rotation","_vectorDirection","_isFlag","_vectorUp","_potentionalSnapObject","_snapToClassName","_snapToConfig","_snapPosition","_possibleSnapPosition","_contactThreshold","_isBelowTerrain","_worldPosition","_isInAir","_numberOfContactsBottom","_startPosition","_endPosition"];("a3s_ConstructionModeLayer"call BIS_fnc_rscLayer) cutRsc["ConstructionTitle","PLAIN",1,false];a3s_IsInConstructionMode=true;a3s_ConstructionResult=0;a3s_ConstructionStartPosition=getPosASL player;_boundingBox=boundingBoxReal a3s_ConstructionObject;_boundingBoxMinimum=_boundingBox select 0;_boundingBoxMaximum=_boundingBox select 1;_boundingBoxPointsTop=[[_boundingBoxMinimum select 0,_boundingBoxMinimum select 1,_boundingBoxMaximum select 2],[_boundingBoxMinimum select 0,_boundingBoxMaximum select 1,_boundingBoxMaximum select 2],[_boundingBoxMaximum select 0,_boundingBoxMinimum select 1,_boundingBoxMaximum select 2],[_boundingBoxMaximum select 0,_boundingBoxMaximum select 1,_boundingBoxMaximum select 2]];_boundingBoxPointsBottom=[[_boundingBoxMinimum select 0,_boundingBoxMinimum select 1,_boundingBoxMinimum select 2],[_boundingBoxMinimum select 0,_boundingBoxMaximum select 1,_boundingBoxMinimum select 2],[_boundingBoxMaximum select 0,_boundingBoxMinimum select 1,_boundingBoxMinimum select 2],[_boundingBoxMaximum select 0,_boundingBoxMaximum select 1,_boundingBoxMinimum select 2],[0,0,_boundingBoxMinimum select 2]];diag_log format["boundingBoxPointsTop: %1 || boundingBoxPointsBottom: %2",_boundingBoxPointsTop,_boundingBoxPointsBottom];a3s_ConstructionBoundingRadius=1+0.5*([_boundingBoxMaximum select 0,_boundingBoxMaximum select 1,0]distance[_boundingBoxMinimum select 0,_boundingBoxMinimum select 1,0]);a3s_ConstructionOffset set[1,5 max a3s_ConstructionBoundingRadius];_objectColor="#(argb,2,2,1)color(0.7,0.93,0,0.6,ca)";_materialColor=_objectColor;_position=[0,0,0];_rotation=0;_vectorDirection=[0,0,0];[]call A3SClient_fnc_gui_constructionMode_update;while{a3s_ConstructionResult isEqualTo 0}do{if(a3s_ConstructionProcess isEqualTo 1) then {if!(a3s_ConstructionKitClassName in(magazines player)) then {a3s_ConstructionResult=2;};};if!(a3s_ConstructionLock) then {_vectorUp=[0,0,1];a3s_ConstructionCanPlaceObject=false;switch(a3s_ConstructionMode) do {case 1:{_position=ASLtoATL(AGLtoASL(player modelToWorld a3s_ConstructionOffset));_rotation=(a3s_ConstructionRotation+(getDir player)+360)%360;_vectorDirection=[sin(_rotation),cos(_rotation),0];};case 2:{_position=ASLtoATL(AGLtoASL(player modelToWorld a3s_ConstructionOffset));_position=[(_position select 0)-((_position select 0)%(a3s_ConstructionGrid select 0)),(_position select 1)-((_position select 1)%(a3s_ConstructionGrid select 1)),(_position select 2)-((_position select 2)%(a3s_ConstructionGrid select 2)) ];_rotation=(a3s_ConstructionRotation+360)%360;_vectorDirection=[sin(_rotation),cos(_rotation),0];};case 3:{a3s_ConstructionIsSnapped=false;if(a3s_ConstructionIsInSelectSnapObjectMode) then {a3s_ConstructionPossibleSnapPositions=[];a3s_ConstructionCurrentSnapToObject=objNull;_position=getPosATL player;_position set[2,-500];_rotation=(a3s_ConstructionRotation+(getDir player)+360)%360;_vectorDirection=[sin(_rotation),cos(_rotation),0];_potentionalSnapObject=cursorTarget;
if!(isNull _potentionalSnapObject) then {if(_potentionalSnapObject distance player<12) then {_snapToClassName=typeOf _potentionalSnapObject;if(_snapToClassName in a3s_ConstructionSnapToObjectClassNames) then {a3s_ConstructionCurrentSnapToObject=_potentionalSnapObject;_snapToConfig=("getText(_x >> 'staticObject') == _snapToClassName"configClasses(configFile>>"CfgConstruction")) select 0;{_snapPosition=getArray(_snapToConfig>>"SnapPositions">>_x);_possibleSnapPosition=ASLtoATL(AGLtoASL(_potentionalSnapObject modelToWorld _snapPosition));if(_possibleSnapPosition select 2>0.26) then{_possibleSnapPosition set[2,0.26];};if(_possibleSnapPosition select 2<-0.2) then{_possibleSnapPosition set[2,-0.2];};a3s_ConstructionPossibleSnapPositions pushBack _possibleSnapPosition;}forEach getArray(a3s_ConstructionConfig>>"SnapObjects">>_snapToClassName>>"positions");};};};}else {_position=ASLtoATL(AGLtoASL(player modelToWorld a3s_ConstructionOffset));_rotation=(a3s_ConstructionRotation+(getDir player)+360)%360;_vectorDirection=[sin(_rotation),cos(_rotation),0];{if(_x distance _position<1) exitWith {_position=_x;_rotation=(a3s_ConstructionRotation+(getDir a3s_ConstructionCurrentSnapToObject)+360)%360;_vectorDirection=[sin(_rotation),cos(_rotation),0];_vectorUp=vectorUp a3s_ConstructionCurrentSnapToObject;a3s_ConstructionIsSnapped=true;};}forEach a3s_ConstructionPossibleSnapPositions;};};};a3s_ConstructionObject setVectorDirAndUp[_vectorDirection,_vectorUp];a3s_ConstructionObject setPosATL _position;};_contactThreshold=0.1;_isBelowTerrain=true;{_worldPosition=ASLtoATL(AGLtoASL(a3s_ConstructionObject modelToWorld _x));if((_worldPosition select 2)>_contactThreshold) exitWith{_isBelowTerrain=false;};}forEach _boundingBoxPointsTop;_isInAir=true;_numberOfContactsBottom=0;{_worldPosition=ASLtoATL(AGLtoASL(a3s_ConstructionObject modelToWorld _x));if((_worldPosition select 2)<_contactThreshold) then {_isInAir=false };_startPosition=ATLtoASL[_worldPosition select 0,_worldPosition select 1,(_worldPosition select 2)+_contactThreshold];_endPosition=ATLtoASL[_worldPosition select 0,_worldPosition select 1,(_worldPosition select 2)-_contactThreshold];if(count lineIntersectsObjs[_startPosition,_endPosition,a3s_ConstructionObject,objNull,false,2]>0) then {_numberOfContactsBottom=_numberOfContactsBottom+1;};}forEach _boundingBoxPointsBottom;if(_isBelowTerrain) then {a3s_ConstructionCanPlaceObject=false;_objectColor="#(argb,2,2,1)color(0.91,0,0,0.6,ca)";}else {a3s_ConstructionCanPlaceObject=true;_objectColor="#(argb,2,2,1)color(0.7,0.93,0,0.6,ca)";};if(a3s_ConstructionMode isEqualTo 3) then {if(!a3s_ConstructionIsSnapped) then {a3s_ConstructionCanPlaceObject=false;_objectColor="#(argb,2,2,1)color(0.91,0,0,0.6,ca)";};};if!(([configName a3s_ConstructionConfig,ASLtoAGL(getPosASL a3s_ConstructionObject),getPlayerUID player]call A3SClient_fnc_construction_canBuildHere) isEqualTo 0) then {a3s_ConstructionCanPlaceObject=false;_objectColor="#(argb,2,2,1)color(0.91,0,0,0.6,ca)";};if(_objectColor!=_materialColor) then {a3s_ConstructionObject setObjectTexture[0,_objectColor];a3s_ConstructionObject setObjectTexture[1,_objectColor];a3s_ConstructionObject setObjectTexture[2,_objectColor];a3s_ConstructionObject setObjectTexture[3,_objectColor];_materialColor=_objectColor;};if(a3s_ConstructionStartPosition distance(getPosASL player)>20) then {a3s_ConstructionResult=3;};if(a3s_inCombat) then {a3s_ConstructionResult=2;};uiSleep 0.001;};call A3SClient_fnc_construction_handleAbort;a3s_ConstructionObject=objNull;a3s_IsInConstructionMode=false;a3s_ConstructionResult=0;a3s_ConstructionProcess=0;a3s_ConstructionLock=false;("a3s_ConstructionModeLayer"call BIS_fnc_rscLayer) cutText["","PLAIN"];true
}